---
on:
  push:
    branches:
      - master
      - testnet
      - buildchain-ci

name: Buildchain
jobs:

  build:
    name: Build
    runs-on: [self-hosted, light]
    steps:

      - name: Clone the repository
        uses: actions/checkout@v2

      - name: Clone buildchain repository
        uses: actions/checkout@v2
        with:
          repository: aurora-is-near/buildchain
          ssh-key: ${{ secrets.BUILDCHAIN_REPO_SSH_KEY }}
          path: buildchain

      - name: Install remaphore
        run: go get -u -v github.com/aurora-is-near/remaphore/cmd/remaphore

      - name: Install uuidgen
        run: apt-get install uuid-runtime

      - name: Configure
        run: ./buildchain/cfg_template/client/configure.sh /etc/buildchain-client
        env:
          NATS_CREDS: ${{secrets.BUILDCHAIN_REMAPHORE_NATS_CREDS}}
          CLIENT_DESTINATION: buildchain.ci_client
          CLIENT_PUB_KEY: ${{secrets.BUILDCHAIN_CI_CLIENT_REMAPHORE_PUBLIC_KEY}}
          CLIENT_PRIV_KEY: ${{secrets.BUILDCHAIN_CI_CLIENT_REMAPHORE_PRIVATE_KEY}}
          SERVER_DESTINATION: buildchain.builder
          SERVER_PUB_KEY: ${{secrets.BUILDCHAIN_BUILDER_REMAPHORE_PUBLIC_KEY}}
          VERBS: build_relayer

      - name: Run build
        run: |
          ./buildchain/client/run.sh \
            buildchain.builder \
            build_relayer \
            "$GITHUB_REF_NAME $GITHUB_SHA"
        env:
          BUILDCHAIN_CLIENT_REMAPHORE_CONFIG: /etc/buildchain-client/remaphore.conf

      - name: Cleanup
        if: ${{ always() }}
        run: rm -rf /etc/buildchain-client || true
